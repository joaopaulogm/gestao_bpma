{
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "title": "Crimes Ambientais - Schema de Dados",
  "description": "Definição oficial do formulário de Crimes Ambientais para scripts de importação, migração e normalização de dados históricos",
  "version": "1.0.0",
  "updated_at": "2025-01-20",
  "target_table": "fat_registros_de_crime",
  "related_tables": {
    "fat_equipe_crime": {
      "description": "Membros da equipe vinculados ao registro de crime",
      "foreign_key": "registro_id",
      "fields": ["efetivo_id"]
    },
    "fat_crime_fauna": {
      "description": "Espécies de fauna envolvidas no crime",
      "foreign_key": "id_ocorrencia",
      "fields": ["especie_id", "estado_saude_id", "estagio_vida_id", "destinacao_id", "atropelamento", "quantidade_adulto", "quantidade_filhote", "quantidade_total"]
    },
    "fat_crime_flora": {
      "description": "Espécies de flora envolvidas no crime",
      "foreign_key": "id_ocorrencia",
      "fields": ["especie_id", "condicao", "destinacao", "quantidade"]
    },
    "fat_ocorrencia_apreensao": {
      "description": "Itens apreendidos na ocorrência",
      "foreign_key": "id_ocorrencia",
      "fields": ["id_item_apreendido", "quantidade"]
    }
  },
  "dimension_tables": {
    "dim_regiao_administrativa": {
      "field": "regiao_administrativa_id",
      "lookup_column": "nome"
    },
    "dim_tipo_de_area": {
      "field": "tipo_area_id",
      "lookup_column": "Tipo de Área"
    },
    "dim_tipo_de_crime": {
      "field": "tipo_crime_id",
      "lookup_column": "Tipo de Crime"
    },
    "dim_enquadramento": {
      "field": "enquadramento_id",
      "lookup_column": "Enquadramento",
      "parent_field": "tipo_crime_id"
    },
    "dim_desfecho": {
      "field": "desfecho_id",
      "lookup_column": "nome",
      "filter": { "tipo": "crime" }
    },
    "dim_area_protegida": {
      "field": "areas_protegidas_ids",
      "lookup_column": "nome",
      "is_array": true
    },
    "dim_itens_apreensao": {
      "used_in": "fat_ocorrencia_apreensao",
      "lookup_columns": ["Item", "Bem Apreendido"]
    },
    "dim_especies_fauna": {
      "used_in": "fat_crime_fauna",
      "lookup_columns": ["nome_popular", "nome_cientifico"]
    },
    "dim_especies_flora": {
      "used_in": "fat_crime_flora",
      "lookup_columns": ["Nome Popular", "Nome Científico"]
    },
    "dim_efetivo": {
      "used_in": "fat_equipe_crime",
      "lookup_columns": ["nome", "matricula", "nome_guerra"]
    }
  },
  "fields": {
    "id": {
      "type": "uuid",
      "required": true,
      "auto_generated": true,
      "default": "gen_random_uuid()",
      "description": "Identificador único do registro"
    },
    "data": {
      "type": "date",
      "required": true,
      "format": "YYYY-MM-DD",
      "description": "Data da ocorrência do crime ambiental",
      "legacy_formats": ["DD/MM/YYYY", "DD-MM-YYYY", "YYYY/MM/DD"],
      "migration_notes": "Converter formatos legados para ISO 8601"
    },
    "latitude": {
      "type": "text",
      "required": true,
      "format": "decimal",
      "validation": {
        "min": -90,
        "max": 90
      },
      "description": "Latitude do local da ocorrência"
    },
    "longitude": {
      "type": "text",
      "required": true,
      "format": "decimal",
      "validation": {
        "min": -180,
        "max": 180
      },
      "description": "Longitude do local da ocorrência"
    },
    "regiao_administrativa_id": {
      "type": "uuid",
      "required": false,
      "references": "dim_regiao_administrativa.id",
      "description": "Região administrativa da ocorrência",
      "legacy_field": "regiao_administrativa"
    },
    "tipo_area_id": {
      "type": "uuid",
      "required": false,
      "references": "dim_tipo_de_area.id",
      "description": "Tipo de área onde ocorreu o crime",
      "legacy_field": "tipo_area"
    },
    "area_protegida": {
      "type": "boolean",
      "required": false,
      "default": false,
      "description": "Indica se ocorreu em área protegida"
    },
    "areas_protegidas_ids": {
      "type": "uuid[]",
      "required": false,
      "default": "[]",
      "references": "dim_area_protegida.id",
      "description": "Lista de áreas protegidas envolvidas",
      "conditional": {
        "when": { "area_protegida": true }
      },
      "legacy_field": "areas_protegidas"
    },
    "tipo_crime_id": {
      "type": "uuid",
      "required": false,
      "references": "dim_tipo_de_crime.id_tipo_de_crime",
      "description": "Tipo de crime ambiental",
      "enums_expected": ["Fauna", "Flora", "Poluição", "Ordenamento Urbano", "Administração Ambiental"],
      "legacy_field": "tipo_crime"
    },
    "enquadramento_id": {
      "type": "uuid",
      "required": false,
      "references": "dim_enquadramento.id_enquadramento",
      "description": "Enquadramento legal do crime",
      "dependent_on": "tipo_crime_id",
      "legacy_field": "enquadramento"
    },
    "desfecho_id": {
      "type": "uuid",
      "required": false,
      "references": "dim_desfecho.id",
      "description": "Desfecho da ocorrência",
      "legacy_field": "desfecho"
    },
    "ocorreu_apreensao": {
      "type": "boolean",
      "required": false,
      "default": false,
      "description": "Indica se houve apreensão de bens"
    },
    "tipo_poluicao": {
      "type": "text",
      "required": false,
      "description": "Tipo de poluição identificada",
      "enums_expected": ["Sonora", "Atmosférica", "Hídrica", "Solo", "Visual"],
      "conditional": {
        "when": { "tipo_crime": "Poluição" }
      }
    },
    "descricao_poluicao": {
      "type": "text",
      "required": false,
      "description": "Descrição detalhada da poluição",
      "conditional": {
        "when": { "tipo_crime": "Poluição" }
      }
    },
    "material_visivel": {
      "type": "text",
      "required": false,
      "description": "Material visível no local"
    },
    "volume_aparente": {
      "type": "text",
      "required": false,
      "description": "Volume aparente do material"
    },
    "origem_aparente": {
      "type": "text",
      "required": false,
      "description": "Origem aparente do crime/poluição"
    },
    "intensidade_percebida": {
      "type": "text",
      "required": false,
      "description": "Intensidade percebida do impacto",
      "enums_expected": ["Baixa", "Média", "Alta", "Muito Alta"]
    },
    "tipo_intervencao": {
      "type": "text",
      "required": false,
      "description": "Tipo de intervenção realizada",
      "conditional": {
        "when": { "tipo_crime": "Ordenamento Urbano" }
      }
    },
    "estruturas_encontradas": {
      "type": "text",
      "required": false,
      "description": "Descrição das estruturas encontradas",
      "conditional": {
        "when": { "tipo_crime": "Ordenamento Urbano" }
      }
    },
    "dano_perceptivel": {
      "type": "text",
      "required": false,
      "description": "Descrição do dano perceptível"
    },
    "tipo_impedimento": {
      "type": "text",
      "required": false,
      "description": "Tipo de impedimento encontrado"
    },
    "risco_imediato": {
      "type": "boolean",
      "required": false,
      "description": "Indica se há risco imediato"
    },
    "mortandade_animais": {
      "type": "boolean",
      "required": false,
      "description": "Indica se houve mortandade de animais"
    },
    "odor_forte": {
      "type": "boolean",
      "required": false,
      "description": "Indica presença de odor forte"
    },
    "alteracao_visual": {
      "type": "boolean",
      "required": false,
      "description": "Indica alteração visual no ambiente"
    },
    "vegetacao_afetada": {
      "type": "boolean",
      "required": false,
      "description": "Indica se vegetação foi afetada"
    },
    "animal_afetado": {
      "type": "boolean",
      "required": false,
      "description": "Indica se animais foram afetados"
    },
    "maquinas_presentes": {
      "type": "boolean",
      "required": false,
      "description": "Indica presença de máquinas no local"
    },
    "qtd_estruturas": {
      "type": "integer",
      "required": false,
      "validation": { "min": 0 },
      "description": "Quantidade de estruturas encontradas"
    },
    "doc_irregular": {
      "type": "boolean",
      "required": false,
      "description": "Indica documentação irregular"
    },
    "veiculo_relacionado": {
      "type": "boolean",
      "required": false,
      "description": "Indica veículo relacionado à ocorrência"
    },
    "material_apreendido_adm": {
      "type": "boolean",
      "required": false,
      "description": "Indica material apreendido administrativamente"
    },
    "material_apreendido_ord": {
      "type": "boolean",
      "required": false,
      "description": "Indica material apreendido por ordenamento"
    },
    "descricao_adm_ambiental": {
      "type": "text",
      "required": false,
      "description": "Descrição de infração administrativa ambiental",
      "conditional": {
        "when": { "tipo_crime": "Administração Ambiental" }
      }
    },
    "descricao_material_adm": {
      "type": "text",
      "required": false,
      "description": "Descrição do material apreendido (administrativo)"
    },
    "descricao_material_ord": {
      "type": "text",
      "required": false,
      "description": "Descrição do material apreendido (ordenamento)"
    },
    "procedimento_legal": {
      "type": "text",
      "required": false,
      "description": "Procedimento legal adotado"
    },
    "tipo_irregularidade_visual": {
      "type": "text",
      "required": false,
      "description": "Tipo de irregularidade visual"
    },
    "qtd_detidos_maior": {
      "type": "integer",
      "required": false,
      "default": 0,
      "validation": { "min": 0 },
      "description": "Quantidade de maiores de idade detidos"
    },
    "qtd_detidos_menor": {
      "type": "integer",
      "required": false,
      "default": 0,
      "validation": { "min": 0 },
      "description": "Quantidade de menores de idade detidos"
    },
    "qtd_liberados_maior": {
      "type": "integer",
      "required": false,
      "default": 0,
      "validation": { "min": 0 },
      "description": "Quantidade de maiores de idade liberados"
    },
    "qtd_liberados_menor": {
      "type": "integer",
      "required": false,
      "default": 0,
      "validation": { "min": 0 },
      "description": "Quantidade de menores de idade liberados"
    },
    "created_at": {
      "type": "timestamp with time zone",
      "required": false,
      "auto_generated": true,
      "default": "now()",
      "description": "Data/hora de criação do registro no sistema"
    }
  },
  "related_schemas": {
    "fat_crime_fauna": {
      "description": "Registros de fauna associados ao crime",
      "fields": {
        "id": { "type": "uuid", "auto_generated": true },
        "id_ocorrencia": { "type": "uuid", "references": "fat_registros_de_crime.id" },
        "especie_id": { "type": "uuid", "references": "dim_especies_fauna.id" },
        "estado_saude_id": { "type": "uuid", "references": "dim_estado_saude.id" },
        "estagio_vida_id": { "type": "uuid", "references": "dim_estagio_vida.id" },
        "destinacao_id": { "type": "uuid", "references": "dim_destinacao.id" },
        "atropelamento": { "type": "boolean", "default": false },
        "quantidade_adulto": { "type": "integer", "default": 0 },
        "quantidade_filhote": { "type": "integer", "default": 0 },
        "quantidade_total": { "type": "integer", "computed": true }
      }
    },
    "fat_crime_flora": {
      "description": "Registros de flora associados ao crime",
      "fields": {
        "id": { "type": "uuid", "auto_generated": true },
        "id_ocorrencia": { "type": "uuid", "references": "fat_registros_de_crime.id" },
        "especie_id": { "type": "uuid", "references": "dim_especies_flora.id" },
        "condicao": { "type": "text" },
        "destinacao": { "type": "text" },
        "quantidade": { "type": "integer", "default": 0 }
      }
    },
    "fat_ocorrencia_apreensao": {
      "description": "Itens apreendidos na ocorrência",
      "fields": {
        "id": { "type": "uuid", "auto_generated": true },
        "id_ocorrencia": { "type": "uuid", "references": "fat_registros_de_crime.id" },
        "id_item_apreendido": { "type": "uuid", "references": "dim_itens_apreensao.id" },
        "quantidade": { "type": "integer", "default": 1 }
      }
    }
  },
  "control_fields": {
    "origem_registro": {
      "type": "text",
      "required": false,
      "description": "Indica a origem do registro para auditoria",
      "enums": ["formulario_web", "importacao_planilha", "migracao_legado", "api"],
      "is_new_field": true,
      "migration_notes": "Preencher com 'migracao_legado' para dados importados"
    },
    "created_at_original": {
      "type": "timestamp",
      "required": false,
      "description": "Data/hora original do registro em sistemas legados",
      "is_new_field": true,
      "migration_notes": "Preservar timestamp original quando disponível"
    }
  },
  "migration_guidelines": {
    "date_handling": "Converter todos os formatos de data para ISO 8601 (YYYY-MM-DD)",
    "null_handling": "Campos vazios ou 'N/A' devem ser convertidos para NULL",
    "enum_normalization": "Normalizar maiúsculas/minúsculas e acentuação antes de buscar IDs",
    "coordinate_format": "Coordenadas devem usar ponto como separador decimal",
    "dimension_lookup": "Sempre buscar IDs nas tabelas de dimensão pelo valor textual",
    "boolean_conversion": {
      "true_values": ["Sim", "sim", "S", "s", "1", "true", "True", "TRUE", "X", "x"],
      "false_values": ["Não", "não", "N", "n", "0", "false", "False", "FALSE", "", null]
    },
    "related_records": "Processar primeiro o registro principal, depois os relacionados usando o ID gerado",
    "unknown_values": "Registrar valores não mapeados em log separado para revisão manual"
  }
}
